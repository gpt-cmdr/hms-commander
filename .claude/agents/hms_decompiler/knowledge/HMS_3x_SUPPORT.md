# HMS 3.x Jython Scripting Support

## Summary

**Contrary to initial assumptions, HMS 3.x versions DO support Jython scripting!**

Through decompilation of HMS 3.3, we discovered that Jython scripting support was added much earlier than HMS 4.0.

## Supported Versions

| Version | Jython Support | Notes |
|---------|---------------|-------|
| 3.3 | ✅ Yes | Confirmed via decompilation |
| 3.4 | ✅ Likely | Same architecture |
| 3.5 | ✅ Likely | Same architecture |
| 3.0-3.2 | ❓ Unknown | Needs testing |

## CLI Options (HMS 3.3)

```
-script <path>   Execute Jython script
-s <path>        Short form of -script
-debug / -d      Enable debug mode
-lite / -l       Lite mode (headless)
```

## JythonHms API (HMS 3.3)

The HMS 3.3 JythonHms API is very similar to HMS 4.x but with some differences:

### Available Methods

| Method | Description |
|--------|-------------|
| `OpenProject(name, path)` | Open HMS project |
| `OpenBasinModel(name)` | Open basin model |
| `Compute(runName)` | Execute simulation run |
| `Optimize()` | Run optimization |
| `Optimize(search, objFunc, trial)` | Run specific optimization |
| `SaveBasinModel()` | Save basin model |
| `SaveBasinModelAs(name)` | Save as new name |
| `SaveAllProjectComponents()` | Save all components |
| `MoveResults(src, dst)` | Move DSS results |
| `SelectOptimizationTrial(...)` | Select optimization trial |
| `SetParameterLock(elem, param, lock)` | Lock parameter |
| `SetPercentMissingAllowed(pct)` | Set missing data threshold |
| `SetObjectiveFunctionTime(type, date, time)` | Set objective function window |
| `UseOptimizerTrialResults(...)` | Apply optimizer results |
| `SetBasinUnitSystem(system)` | Set units (English/SI/Metric) |
| `SetBlendMethod(elem, method)` | Set blend method |
| `SetBaseflowValue(elem, param, value)` | Set baseflow parameter |
| `SetLossRateValue(elem, param, value)` | Set loss rate parameter |
| `Exit(code)` / `HMSExit(code)` | Exit script |

### Key Differences from HMS 4.x

1. **No `ComputeRun`/`ComputeTrial`/`ComputeForecast`** - Use `Compute()` instead
2. **`Optimize()` works** - In 4.x it throws NotImplemented
3. **`MoveResults` vs `CopyRunResults`** - Different method name
4. **`SelectOptimizationTrial` works** - In 4.x it throws NotImplemented
5. **`SetParameterLock` works** - In 4.x it throws NotImplemented

## Example Script (HMS 3.3)

```python
from hms.model import JythonHms

# Open project
JythonHms.OpenProject("MyProject", "C:/HMS/MyProject")

# Open basin
JythonHms.OpenBasinModel("MyBasin")

# Modify parameters
JythonHms.SetLossRateValue("Subbasin1", "SCSCurveNumber", 75)

# Run simulation
JythonHms.Compute("Run 1")

# Save
JythonHms.SaveAllProjectComponents()

# Exit
JythonHms.Exit(0)
```

## Execution

```bash
# Navigate to HMS 3.3 directory (required for relative paths in batch file)
cd "C:\Program Files (x86)\HEC\HEC-HMS\3.3"

# Execute script
HEC-HMS.cmd -script "C:\path\to\script.py"
```

## Architecture Notes

HMS 3.3 uses:
- 32-bit Java (in `java\` subdirectory)
- Native DLLs: jniLibHydro.dll, javaHeclib.dll, etc.
- Jython library: `lib\jython.jar`

The entry point class `hms.Hms` has a simpler structure than 4.x:
- No RMI Command Server support
- No `-info` flag
- Debug mode launches a GUI test panel

## hms-commander Support Status

**HMS 3.3+ is now fully supported in hms-commander!** (implemented 2025-12-10)

### Implementation Details

The following changes were made to `HmsJython.py`:

1. **Version check updated** - `_check_version_supported()` now allows HMS 3.3+
2. **New execution method** - `_execute_via_java_3x()` handles 32-bit Java execution
3. **Explicit classpath builder** - `_build_classpath_3x()` builds jar list without wildcards
4. **Python 2 script generation** - `_generate_compute_script_py2()` for Jython compatibility
5. **Automatic routing** - `execute_script()` detects version and uses appropriate method

### Usage with hms-commander

```python
from hms_commander import HmsJython

# Generate Python 2 compatible script (required for HMS 3.x)
script = HmsJython.generate_compute_script(
    project_path="C:/Projects/MyOldProject",
    run_name="Run 1",
    python2_compatible=True
)

# Execute - version is auto-detected from path
success, stdout, stderr = HmsJython.execute_script(
    script_content=script,
    hms_exe_path="C:/Program Files (x86)/HEC/HEC-HMS/3.3",
    working_dir="C:/Projects/MyOldProject"
)
```

### Test Results (2025-12-10)

Successfully tested with HMS 3.3 sample project "tifton":
```
TEST PASSED: HMS 3.3 execution completed successfully!
- Project opened: tifton
- Simulation "Run 1" computed
- Results saved to DSS
- Exit status: 0
```

---
*Generated by hms-commander decompilation analysis*
*HMS Version: 3.3*
*Last updated: 2025-12-10*
